#!/usr/bin/env python3

import sys
import os
import base64
import cbor2
import json
from OpenSSL import crypto
import pytest

from Crypto.PublicKey import RSA


from verifiably_checker import attestation


EXAMPLE_ATT_DOC = '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'

def test_check_correct_pcr():
    doc_obj = {'pcrs':{
        0: bytes.fromhex('a123'),
        1: bytes.fromhex('b456')
        }
    }

    expected_pcrs = {'0':'a123', '1':'b456'}

    assert attestation.verify_pcrs(doc_obj, expected_pcrs) == True


def test_check_wrong_pcr():
    doc_obj = {'pcrs':{
        0: bytes.fromhex('a123'),
        1: bytes.fromhex('b456')
        }
    }

    expected_pcrs = {'0':'a12', '1':'b456'}

    assert attestation.verify_pcrs(doc_obj, expected_pcrs) == False


def test_validate_signature():
    attestation_doc = base64.b64decode(EXAMPLE_ATT_DOC)

    data = cbor2.loads(attestation_doc)
    doc = data[2]
    doc_obj = cbor2.loads(doc)

    assert attestation.validate_signature(data, doc, doc_obj) == True


def test_validate_signature_modify_user_data():
    attestation_doc = base64.b64decode(EXAMPLE_ATT_DOC)

    data = cbor2.loads(attestation_doc)
    doc = data[2]
    doc_obj = cbor2.loads(doc)

    # Modify user data
    user_data = json.loads(doc_obj['user_data'])
    user_data['result'] = True
    doc_obj['user_data'] = json.dumps(user_data)
    doc = cbor2.dumps(doc_obj)


    assert attestation.validate_signature(data, doc, doc_obj) == False


def test_validate_signature_modify_public_key():
    attestation_doc = base64.b64decode(EXAMPLE_ATT_DOC)

    data = cbor2.loads(attestation_doc)
    doc = data[2]
    doc_obj = cbor2.loads(doc)

    # Modify user data
    rsa_key = RSA.generate(2048)
    public_key = rsa_key.publickey().export_key('DER')
    doc_obj['public_key'] = public_key
    doc = cbor2.dumps(doc_obj)


    assert attestation.validate_signature(data, doc, doc_obj) == False


def test_validate_signature_modify_signature():
    attestation_doc = base64.b64decode(EXAMPLE_ATT_DOC)

    data = cbor2.loads(attestation_doc)
    doc = data[2]
    doc_obj = cbor2.loads(doc)

    # Modify signature

    signature_value = data[3].hex()
    signature_value = 'b' + signature_value[1:]
    data[3] = bytes.fromhex(signature_value)


    assert attestation.validate_signature(data, doc, doc_obj) == False


def test_validate_certificate():
    certificate = '3082027c30820201a0030201020210017fb8b2974076e900000000623b9237300a06082a8648ce3d04030330818e310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533139303706035504030c30692d30646462303366366631663135633861662e75732d656173742d322e6177732e6e6974726f2d656e636c61766573301e170d3232303332333231333334305a170d3232303332343030333334335a308193310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313e303c06035504030c35692d30646462303366366631663135633861662d656e63303137666238623239373430373665392e75732d656173742d322e6177733076301006072a8648ce3d020106052b810400220362000461501d1c1bdc606ef8ae45fd369f92132a5575dd9c1f93fe1913f832ad9324a4ae1e83d611045b84d37b790799023d6801a987022ab469fa142434bff9f024d33a22a2b412480d06c4ad8e216e29f2594c30899793ff081ad2b90d73037e7682a31d301b300c0603551d130101ff04023000300b0603551d0f0404030206c0300a06082a8648ce3d0403030369003066023100c041d21e244d9d6b694c6dedb97b54f93d08d1eca2a4db11e55d6791a7f1a003ffad20aafd5a3f90aaa32f392fd856b0023100c4a5c84ae1e2cf3b3dda30b6e54805d76ba565e914ad75daee1b7a6bb07e373912c23d9f7375d2198ca28c88818b2365'

    attestation_doc = base64.b64decode(EXAMPLE_ATT_DOC)

    data = cbor2.loads(attestation_doc)
    doc = data[2]
    doc_obj = cbor2.loads(doc)
    doc_obj['certificate'] = bytes.fromhex(certificate)
    assert attestation.validate_pki(doc_obj) == True


def test_validate_wrong_certificate():
    certificate = '1082027c30820201a0030201020210017fb8b2974076e900000000623b9237300a06082a8648ce3d04030330818e310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c034157533139303706035504030c30692d30646462303366366631663135633861662e75732d656173742d322e6177732e6e6974726f2d656e636c61766573301e170d3232303332333231333334305a170d3232303332343030333334335a308193310b30090603550406130255533113301106035504080c0a57617368696e67746f6e3110300e06035504070c0753656174746c65310f300d060355040a0c06416d617a6f6e310c300a060355040b0c03415753313e303c06035504030c35692d30646462303366366631663135633861662d656e63303137666238623239373430373665392e75732d656173742d322e6177733076301006072a8648ce3d020106052b810400220362000461501d1c1bdc606ef8ae45fd369f92132a5575dd9c1f93fe1913f832ad9324a4ae1e83d611045b84d37b790799023d6801a987022ab469fa142434bff9f024d33a22a2b412480d06c4ad8e216e29f2594c30899793ff081ad2b90d73037e7682a31d301b300c0603551d130101ff04023000300b0603551d0f0404030206c0300a06082a8648ce3d0403030369003066023100c041d21e244d9d6b694c6dedb97b54f93d08d1eca2a4db11e55d6791a7f1a003ffad20aafd5a3f90aaa32f392fd856b0023100c4a5c84ae1e2cf3b3dda30b6e54805d76ba565e914ad75daee1b7a6bb07e373912c23d9f7375d2198ca28c88818b2365'

    attestation_doc = base64.b64decode(EXAMPLE_ATT_DOC)

    data = cbor2.loads(attestation_doc)
    doc = data[2]
    doc_obj = cbor2.loads(doc)
    doc_obj['certificate'] = bytes.fromhex(certificate)
    with pytest.raises(crypto.Error):
        attestation.validate_pki(doc_obj)
